 INSERT INTO ADW_DEV.ADW_DQ_AUDIT.DATA_QUALITY_LOG (
   target_table_primary_key_val
  ,target_object
  ,target_attribute_name
  ,source_object
  ,exception_target_load_ts
  ,exception_severity_level
  ,dq_rule_id
  ,dq_log_ts
  ,dq_log_id
  ,dq_exception_val 
  ,business_ts
  ,business_domain
)
SELECT 
   'TRANSACTION_KEY'
  ,'INC_PL.PAY_ITEM_FACT'
  ,'N/A'
  ,'ADW_PL.FACT_SALES_TRANS_PAYMENT' /*Transaction Key comes from TRANSACTION_DIM and the rest from ADW_PL.FACT_SALES_TRANS_PAYMENT  */
  ,DATE_KEY
  ,3
  ,2
  ,TO_TIMESTAMP_NTZ(CURRENT_TIMESTAMP())
  ,adw_dev.adw_dq_audit.data_quality_log_id.nextval
  ,TRANSACTION_KEY
  ,DATE_KEY
  ,'SALES'   
FROM 
  "ADW_PROD"."INC_PL"."TRANSACTION_DIM"
WHERE
  ( TRANSACTION_KEY) IN
  (
 SELECT DISTINCT TRANSACTION_KEY
 FROM "ADW_PROD"."INC_PL"."TRANSACTION_DIM", "ADW_PROD"."ADW_PL"."FACT_SALES_TRANS_PAYMENT"
 WHERE 
 TRANSACTION_DIM.LOCATION_KEY = FACT_SALES_TRANS_PAYMENT.STORE_CD AND
 TRANSACTION_DIM.TILL_NUMBER = FACT_SALES_TRANS_PAYMENT.TILL_NUM AND
 TRANSACTION_DIM.DATE_KEY = FACT_SALES_TRANS_PAYMENT.TRAN_DT AND
 SUBSTRING(TRANSACTION_TIME::TEXT,0,2)::int::TEXT||SUBSTRING(TRANSACTION_TIME::TEXT,4,2)||SUBSTRING(TRANSACTION_TIME::TEXT,7,2)::int = FACT_SALES_TRANS_PAYMENT.TRAN_TM AND
 TRANSACTION_DIM.TRANSACTION_NUMBER = FACT_SALES_TRANS_PAYMENT.TRAN_NUM AND
 FACT_SALES_TRANS_PAYMENT.PYMT_CD = '003' /*Select only Coupon related payment lines */ AND
 FACT_SALES_TRANS_PAYMENT.TRAN_DT>current_date()-30
 minus
 select 
 TRANSACTION_KEY
 FROM "ADW_PROD"."INC_PL"."PAY_ITEM_FACT"
 WHERE DATE_KEY>current_date()-30)
