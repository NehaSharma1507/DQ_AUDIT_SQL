 INSERT INTO ADW_DEV.ADW_DQ_AUDIT.DATA_QUALITY_LOG (
   target_table_primary_key_val
  ,target_object
  ,target_attribute_name
  ,source_object
  ,exception_target_load_ts
  ,exception_severity_level
  ,dq_rule_id
  ,dq_log_ts
  ,dq_log_id
  ,dq_exception_val 
  ,business_ts
  ,business_domain
)
SELECT 
   'STORE_CD|TILL_NUM|TRAN_NUM|TRAN_DT'
  ,'INC_PL.TRANSACTION_DIM'
  ,'N/A'
  ,'ADW_PL.FACT_SALES_TRANS_HDR'
  ,tran_dt
  ,3
  ,2
  ,TO_TIMESTAMP_NTZ(CURRENT_TIMESTAMP())
  ,adw_dev.adw_dq_audit.data_quality_log_id.nextval
  ,STORE_CD||'|'||TILL_NUM||'|'||TRAN_NUM||'|'||TRAN_DT
  ,tran_dt
  ,'SALES'   
FROM 
  "ADW_PROD"."ADW_PL"."FACT_SALES_TRANS_HDR"
WHERE
  (STORE_CD,TILL_NUM,TRAN_NUM,TRAN_DT) IN
  (
 Select A.STORE_CD,A.TILL_NUM,A.TRAN_NUM,A.TRAN_DT
 FROM 
  (SELECT FACT_SALES_TRANS_HDR.STORE_CD,FACT_SALES_TRANS_HDR.TILL_NUM,FACT_SALES_TRANS_HDR.TRAN_NUM,FACT_SALES_TRANS_HDR.TRAN_DT,FACT_SALES_TRANS_HDR.TRAN_TM
 FROM  "ADW_PROD"."ADW_PL"."FACT_SALES_TRANS_LINE" ,"ADW_PROD"."ADW_PL"."FACT_SALES_TRANS_HDR"
 WHERE FACT_SALES_TRANS_HDR.STORE_CD=FACT_SALES_TRANS_LINE.STORE_CD and
 FACT_SALES_TRANS_HDR.TILL_NUM=FACT_SALES_TRANS_LINE.TILL_NUM and
 FACT_SALES_TRANS_HDR.TRAN_NUM=FACT_SALES_TRANS_LINE.TRAN_NUM and
 FACT_SALES_TRANS_HDR.TRAN_DT=FACT_SALES_TRANS_LINE.TRAN_DT and
 FACT_SALES_TRANS_HDR.TRAN_TM=FACT_SALES_TRANS_LINE.TRAN_TM
 and FACT_SALES_TRANS_HDR.TRAN_DT>current_date()-30
 and translated_order_num<>0
 and customer_order_num is not null) as A 
 LEFT JOIN
 (select FACT_SALES_TRANS_HDR.STORE_CD,FACT_SALES_TRANS_HDR.TILL_NUM,FACT_SALES_TRANS_HDR.TRAN_NUM,FACT_SALES_TRANS_HDR.TRAN_DT,FACT_SALES_TRANS_HDR.TRAN_TM
 FROM "ADW_PROD"."ADW_PL"."FACT_SALES_TRANS_MISSION","ADW_PROD"."ADW_PL"."FACT_SALES_TRANS_HDR"
 WHERE
 FACT_SALES_TRANS_HDR.STORE_CD=FACT_SALES_TRANS_MISSION.STORE_CD AND
 FACT_SALES_TRANS_HDR.TILL_NUM=FACT_SALES_TRANS_MISSION.TILL_NUM AND
 FACT_SALES_TRANS_HDR.TRAN_NUM=FACT_SALES_TRANS_MISSION.TRAN_NUM AND
 FACT_SALES_TRANS_HDR.TRAN_DT=FACT_SALES_TRANS_MISSION.TRAN_DT AND
 FACT_SALES_TRANS_HDR.TRAN_TM=FACT_SALES_TRANS_MISSION.TRAN_TM) as B
 on 
 A.STORE_CD=B.STORE_CD AND
 A.TILL_NUM=B.TILL_NUM AND
 A.TRAN_NUM=B.TRAN_NUM AND 
 A.TRAN_DT=B.TRAN_DT AND 
 A.TRAN_TM=B.TRAN_TM
 MINUS
 SELECT LOCATION_KEY,TILL_NUMBER,TRANSACTION_NUMBER,DATE_KEY
 FROM "ADW_PROD"."INC_PL"."TRANSACTION_DIM"
 WHERE DATE_KEY>current_date()-30)
